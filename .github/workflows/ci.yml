name: ğŸ§ª Test Automation CI/CD

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - web
          - mobile

env:
  NODE_VERSION: '18'

jobs:
  web-tests:
    name: ğŸŒ Web Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_type == 'web' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == '' }}
    outputs:
      PASSED_COUNT: ${{ steps.parse.outputs.PASSED_COUNT }}
      FAILED_COUNT: ${{ steps.parse.outputs.FAILED_COUNT }}
      TOTAL_COUNT: ${{ steps.parse.outputs.TOTAL_COUNT }}
      FAILED_TESTS: ${{ steps.details.outputs.FAILED_TESTS }}
      REPORT_URL: ${{ steps.upload-report.outputs.report_url || '' }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸ­ Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: ğŸ§ª Run Playwright tests
        run: |
          mkdir -p test-results
          npx playwright test --config=config/playwright.config.js --reporter=line \
            2>&1 | tee test-output.log || true

      - name: ğŸ“ Upload Playwright HTML report
        if: always()
        id: upload-report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report
          path: playwright-report

      - name: ğŸ“Š Parse Playwright Summary Counts
        id: parse
        if: always()
        run: |
          OUTPUT=$(cat test-output.log || true)

          PASSED=$(echo "$OUTPUT" | grep -Eo "[0-9]+ passed" | grep -Eo "[0-9]+" | head -1 || echo 0)
          FAILED=$(echo "$OUTPUT" | grep -Eo "[0-9]+ failed" | grep -Eo "[0-9]+" | head -1 || echo 0)

          # If Playwright prints "0 passed" not found, ensure defaults
          if [ -z "$PASSED" ]; then PASSED=0; fi
          if [ -z "$FAILED" ]; then FAILED=0; fi

          TOTAL=$((PASSED + FAILED))

          echo "PASSED_COUNT=$PASSED" >> $GITHUB_OUTPUT
          echo "FAILED_COUNT=$FAILED" >> $GITHUB_OUTPUT
          echo "TOTAL_COUNT=$TOTAL" >> $GITHUB_OUTPUT

      - name: ğŸ” Extract Playwright Failed Test Names (from JSON)
        id: details
        if: always()
        run: |
          FAILED_TESTS="results.json not found"
          if [ -f test-results/results.json ]; then
            # extract failing tests titles (works for Playwright json shape)
            FAILED_TESTS=$(jq -r '
              def walk_tests:
                .suites[]?.specs[]? |
                .tests[]? |
                { title: .title, status: .status } ;
              [ walk_tests | select(.status=="failed") | .title ] | join("\n")
            ' test-results/results.json || true)

            if [ -z "$FAILED_TESTS" ]; then
              FAILED_TESTS="No failed tests ğŸ‰"
            fi
          else
            # fallback: parse console output log for failed test names (best-effort)
            if grep -q "failed" test-output.log 2>/dev/null; then
              FAILED_TESTS=$(grep -nE "failed|FAIL" test-output.log | sed -n '1,200p' | sed ':a;N;$!ba;s/\n/\\n/g' || echo "See test-output.log")
            fi
          fi

          # sanitize for GITHUB_OUTPUT (avoid bare newlines â€” keep \n)
          FAILED_TESTS_ESCAPED=$(echo "$FAILED_TESTS" | sed ':a;N;$!ba;s/\n/\\n/g' )
          echo "FAILED_TESTS=$FAILED_TESTS_ESCAPED" >> $GITHUB_OUTPUT

  mobile-tests:
    name: ğŸ“± Mobile Tests (WebdriverIO + Appium)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_type == 'mobile' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == '' }}
    outputs:
      PASSED_COUNT: ${{ steps.parse.outputs.PASSED_COUNT }}
      FAILED_COUNT: ${{ steps.parse.outputs.FAILED_COUNT }}
      TOTAL_COUNT: ${{ steps.parse.outputs.TOTAL_COUNT }}
      FAILED_TESTS: ${{ steps.details.outputs.FAILED_TESTS }}
      ARTIFACT_URL: ${{ steps.upload-artifacts.outputs.artifact_url || '' }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§° Install Appium (local start)
        run: |
          # Install Appium locally so we can run it if tests require a local server.
          # If you use cloud device provider/remove local start as appropriate.
          npm i -g appium@2 || true

      - name: ğŸš€ Start Appium in background
        if: always()
        run: |
          # start appium in background to listen on default 4723
          # logs go to appium-server.log
          nohup appium --log-level error > appium-server.log 2>&1 &
          # give Appium a bit of time to warm up
          sleep 3

      - name: ğŸ§ª Run Mobile Tests (WebdriverIO)
        run: |
          mkdir -p tests/mobile/results || true
          # Attempt common wdio invocation; adjust if your repo uses a different command
          if [ -f ./tests/mobile/wdio.conf.js ]; then
            # Use json reporter if possible (write to tests/mobile/results.json)
            npx wdio run ./tests/mobile/wdio.conf.js --reporters json --reporter-options outputDir=./tests/mobile || true
          else
            # fallback to your npm script (you mentioned test:mobile)
            npm run test:mobile 2>&1 | tee mobile-output.log || true
          fi

      - name: ğŸ“ Upload Mobile artifacts (logs & reports)
        id: upload-artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-reports
          path: |
            tests/mobile/results
            tests/mobile/report*
            tests/mobile/allure-results
            mobile-output.log
            appium-server.log

      - name: ğŸ“Š Parse Mobile Summary Counts
        id: parse
        if: always()
        run: |
          PASSED=0
          FAILED=0

          # try JSON result location(s)
          if [ -f tests/mobile/results/results.json ]; then
            # attempt to parse a generic results.json shape
            PASSED=$(jq '[.suites[].specs[].tests[]? | select(.status=="passed")] | length' tests/mobile/results/results.json 2>/dev/null || echo 0)
            FAILED=$(jq '[.suites[].specs[].tests[]? | select(.status=="failed")] | length' tests/mobile/results/results.json 2>/dev/null || echo 0)
          elif [ -f tests/mobile/results.json ]; then
            PASSED=$(jq '[.tests[]? | select(.status=="passed")] | length' tests/mobile/results.json 2>/dev/null || echo 0)
            FAILED=$(jq '[.tests[]? | select(.status=="failed")] | length' tests/mobile/results.json 2>/dev/null || echo 0)
          else
            # fallback to grepping mobile-output.log
            if [ -f mobile-output.log ]; then
              PASSED=$(grep -Eo "[0-9]+ passing" mobile-output.log | grep -Eo "[0-9]+" | head -1 || echo 0)
              FAILED=$(grep -Eo "[0-9]+ failing" mobile-output.log | grep -Eo "[0-9]+" | head -1 || echo 0)
            fi
          fi

          if [ -z "$PASSED" ]; then PASSED=0; fi
          if [ -z "$FAILED" ]; then FAILED=0; fi

          TOTAL=$((PASSED + FAILED))

          echo "PASSED_COUNT=$PASSED" >> $GITHUB_OUTPUT
          echo "FAILED_COUNT=$FAILED" >> $GITHUB_OUTPUT
          echo "TOTAL_COUNT=$TOTAL" >> $GITHUB_OUTPUT

      - name: ğŸ” Extract Mobile Failed Test Names (logs or JSON)
        id: details
        if: always()
        run: |
          FAILED_TESTS="No failed tests ğŸ‰"

          if [ -f tests/mobile/results/results.json ]; then
            # example generic extraction
            FAILED_TESTS=$(jq -r '[.suites[].specs[].tests[]? | select(.status=="failed") | .title] | join("\n")' tests/mobile/results/results.json 2>/dev/null || true)
          elif [ -f tests/mobile/results.json ]; then
            FAILED_TESTS=$(jq -r '[.tests[]? | select(.status=="failed") | .fullTitle // .title] | join("\n")' tests/mobile/results.json 2>/dev/null || true)
          elif [ -f mobile-output.log ]; then
            # Best-effort grep for failing lines (Mocha/WebdriverIO style)
            FAILED_TESTS=$(grep -nE "fail|FAIL|AssertionError|Error:" mobile-output.log | sed -n '1,200p' | sed ':a;N;$!ba;s/\n/\\n/g' || true)
          fi

          if [ -z "$FAILED_TESTS" ]; then
            FAILED_TESTS="No failed tests ğŸ‰"
          fi

          FAILED_TESTS_ESCAPED=$(echo "$FAILED_TESTS" | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "FAILED_TESTS=$FAILED_TESTS_ESCAPED" >> $GITHUB_OUTPUT

  slack-results:
    name: ğŸ“¢ Slack Notification
    runs-on: ubuntu-latest
    needs: [web-tests, mobile-tests]
    if: always()

    steps:
      - name: ğŸ§¾ Gather final results
        id: summary
        run: |
          # Web outputs
          WEB_PASSED="${{ needs.web-tests.outputs.PASSED_COUNT || '0' }}"
          WEB_FAILED="${{ needs.web-tests.outputs.FAILED_COUNT || '0' }}"
          WEB_TOTAL="${{ needs.web-tests.outputs.TOTAL_COUNT || '0' }}"
          WEB_FAILED_LIST="${{ needs.web-tests.outputs.FAILED_TESTS || 'No results available' }}"

          # Mobile outputs
          MOBILE_PASSED="${{ needs.mobile-tests.outputs.PASSED_COUNT || '0' }}"
          MOBILE_FAILED="${{ needs.mobile-tests.outputs.FAILED_COUNT || '0' }}"
          MOBILE_TOTAL="${{ needs.mobile-tests.outputs.TOTAL_COUNT || '0' }}"
          MOBILE_FAILED_LIST="${{ needs.mobile-tests.outputs.FAILED_TESTS || 'No results available' }}"

          # report/artifact link (artifact page of this run)
          REPORT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts"

          # prepare outputs (escape newlines already escaped in job outputs)
          echo "web_passed=$WEB_PASSED" >> $GITHUB_OUTPUT
          echo "web_failed=$WEB_FAILED" >> $GITHUB_OUTPUT
          echo "web_total=$WEB_TOTAL" >> $GITHUB_OUTPUT
          echo "web_failed_tests=$WEB_FAILED_LIST" >> $GITHUB_OUTPUT

          echo "mobile_passed=$MOBILE_PASSED" >> $GITHUB_OUTPUT
          echo "mobile_failed=$MOBILE_FAILED" >> $GITHUB_OUTPUT
          echo "mobile_total=$MOBILE_TOTAL" >> $GITHUB_OUTPUT
          echo "mobile_failed_tests=$MOBILE_FAILED_LIST" >> $GITHUB_OUTPUT

          echo "report_url=$REPORT_URL" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Send Slack Report
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ§ª Automated Test Report",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Repository:*\n${{ github.repository }}" },
                    { "type": "mrkdwn", "text": "*Branch:*\n${{ github.ref_name }}" },
                    { "type": "mrkdwn", "text": "*Triggered by:*\n${{ github.actor }}" }
                  ]
                },
                { "type": "divider" },

                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸŒ Web Test Summary:*\nâœ… ${{ steps.summary.outputs.web_passed }} Passed\nâŒ ${{ steps.summary.outputs.web_failed }} Failed\nğŸ“‹ ${{ steps.summary.outputs.web_total }} Total"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*âŒ Web Failed Tests:*\n${{ steps.summary.outputs.web_failed_tests }}"
                  }
                },

                { "type": "divider" },

                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸ“± Mobile Test Summary:*\nâœ… ${{ steps.summary.outputs.mobile_passed }} Passed\nâŒ ${{ steps.summary.outputs.mobile_failed }} Failed\nğŸ“‹ ${{ steps.summary.outputs.mobile_total }} Total"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*âŒ Mobile Failed Tests:*\n${{ steps.summary.outputs.mobile_failed_tests }}"
                  }
                },

                { "type": "divider" },

                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸ“„ Download HTML Report",
                        "emoji": true
                      },
                      "url": "${{ steps.summary.outputs.report_url }}",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸ“Š Open CI Run",
                        "emoji": true
                      },
                      "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}


          
# name: ğŸ§ª Test Automation CI/CD

# on:
#   push:
#     branches: [ main, develop, master ]
#   pull_request:
#     branches: [ main, develop, master ]
#   # schedule:
#   #   - cron: '0 2 * * *'
#   workflow_dispatch:
#     inputs:
#       test_type:
#         description: 'Test type to run'
#         required: true
#         default: 'all'
#         type: choice
#         options:
#           - all
#           - web
#           - mobile

# env:
#   NODE_VERSION: '18'

# jobs:
#   web-tests:
#     name: ğŸŒ Web Tests
#     runs-on: ubuntu-latest
#     if: ${{ github.event.inputs.test_type == 'web' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == '' }}
#     outputs:
#       PASSED_COUNT: ${{ steps.web-results.outputs.PASSED_COUNT }}
#       FAILED_COUNT: ${{ steps.web-results.outputs.FAILED_COUNT }}
#       TOTAL_COUNT: ${{ steps.web-results.outputs.TOTAL_COUNT }}
    
#     steps:
#       - name: ğŸ“¥ Checkout code
#         uses: actions/checkout@v4

#       - name: ğŸ”§ Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: ${{ env.NODE_VERSION }}

#       - name: ğŸ“¦ Install dependencies
#         run: npm install

#       - name: ğŸ­ Install Playwright
#         run: npx playwright install

#       - name: ğŸ§ª Run Playwright tests
#         env:
#           APP_URL: ${{ secrets.APP_URL || 'https://example.com' }}
#         run: |
#           echo "Starting Playwright tests..."
#           npx playwright test --config=config/playwright.config.js --reporter=line 2>&1 | tee test-output.log || true

#       - name: ğŸ“Š Parse Web Test Results
#         id: web-results
#         if: always()
#         run: |
#           OUTPUT=$(cat test-output.log)
#           echo "=== TEST OUTPUT START ==="
#           echo "$OUTPUT"
#           echo "=== TEST OUTPUT END ==="

#           PASSED=$(echo "$OUTPUT" | grep -E "([0-9]+) passed" | grep -oE "[0-9]+" | head -1 || echo "0")
#           FAILED=$(echo "$OUTPUT" | grep -E "([0-9]+) failed" | grep -oE "[0-9]+" | head -1 || echo "0")

#           if [ -z "$PASSED" ] || [ "$PASSED" = "" ]; then PASSED=0; fi
#           if [ -z "$FAILED" ] || [ "$FAILED" = "" ]; then FAILED=0; fi

#           TOTAL=$((PASSED + FAILED))

#           echo "PASSED_COUNT=$PASSED" >> $GITHUB_OUTPUT
#           echo "FAILED_COUNT=$FAILED" >> $GITHUB_OUTPUT
#           echo "TOTAL_COUNT=$TOTAL" >> $GITHUB_OUTPUT
          
#           echo "ğŸŒ Web Test Results: $PASSED passed, $FAILED failed, $TOTAL total"

#   mobile-tests:
#     name: ğŸ“± Mobile Tests
#     runs-on: ubuntu-latest
#     if: ${{ github.event.inputs.test_type == 'mobile' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == '' }}
#     outputs:
#       PASSED_COUNT: ${{ steps.mobile-results.outputs.PASSED_COUNT }}
#       FAILED_COUNT: ${{ steps.mobile-results.outputs.FAILED_COUNT }}
#       TOTAL_COUNT: ${{ steps.mobile-results.outputs.TOTAL_COUNT }}
    
#     steps:
#       - name: ğŸ“¥ Checkout code
#         uses: actions/checkout@v4

#       - name: ğŸ”§ Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: ${{ env.NODE_VERSION }}

#       - name: ğŸ“¦ Install dependencies
#         run: npm install

#       - name: ğŸ§ª Run Mobile tests
#         run: |
#           echo "Starting mobile tests..."
#           npm run test:mobile 2>&1 | tee mobile-output.log || true

#       - name: ğŸ“Š Parse Mobile Test Results
#         id: mobile-results
#         if: always()
#         run: |
#           # Example placeholder values
#           PASSED="3"
#           FAILED="0"
#           TOTAL="3"

#           echo "PASSED_COUNT=$PASSED" >> $GITHUB_OUTPUT
#           echo "FAILED_COUNT=$FAILED" >> $GITHUB_OUTPUT
#           echo "TOTAL_COUNT=$TOTAL" >> $GITHUB_OUTPUT
          
#           echo "ğŸ“± Mobile Test Results: $PASSED passed, $FAILED failed, $TOTAL total"

#   slack-results:
#     name: ğŸ“¢ Slack Notification
#     runs-on: ubuntu-latest
#     needs: [web-tests, mobile-tests]
#     if: always()
    
#     steps:
#       - name: ğŸ“Š Combine Final Results
#         id: final-results
#         run: |
#           WEB_PASSED=${{ needs.web-tests.outputs.PASSED_COUNT || 0 }}
#           WEB_FAILED=${{ needs.web-tests.outputs.FAILED_COUNT || 0 }}
#           WEB_TOTAL=${{ needs.web-tests.outputs.TOTAL_COUNT || 0 }}
          
#           MOBILE_PASSED=${{ needs.mobile-tests.outputs.PASSED_COUNT || 0 }}
#           MOBILE_FAILED=${{ needs.mobile-tests.outputs.FAILED_COUNT || 0 }}
#           MOBILE_TOTAL=${{ needs.mobile-tests.outputs.TOTAL_COUNT || 0 }}
          
#           echo "Web Results: $WEB_PASSED passed, $WEB_FAILED failed, $WEB_TOTAL total"
#           echo "Mobile Results: $MOBILE_PASSED passed, $MOBILE_FAILED failed, $MOBILE_TOTAL total"

#           TOTAL_PASSED=$((WEB_PASSED + MOBILE_PASSED))
#           TOTAL_FAILED=$((WEB_FAILED + MOBILE_FAILED))
#           TOTAL_TESTS=$((TOTAL_PASSED + TOTAL_FAILED))
          
#           echo "TOTAL_PASSED=$TOTAL_PASSED" >> $GITHUB_OUTPUT
#           echo "TOTAL_FAILED=$TOTAL_FAILED" >> $GITHUB_OUTPUT
#           echo "TOTAL_TESTS=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          
#           if [ $TOTAL_FAILED -eq 0 ] && [ $TOTAL_TESTS -gt 0 ]; then
#             echo "STATUS=ğŸ‰ All tests passed" >> $GITHUB_OUTPUT
#           elif [ $TOTAL_FAILED -gt 0 ]; then
#             echo "STATUS=âš ï¸ Some tests failed" >> $GITHUB_OUTPUT
#           else
#             echo "STATUS=ğŸ”§ No tests executed" >> $GITHUB_OUTPUT
#           fi

#       - name: ğŸ“¤ Send Slack Report
#         uses: slackapi/slack-github-action@v1.24.0
#         with:
#           payload: |
#             {
#               "text": "ğŸ§ª Test Report - ${{ github.repository }}\n\nâœ… ${{ steps.final-results.outputs.TOTAL_PASSED }} Passed | âŒ ${{ steps.final-results.outputs.TOTAL_FAILED }} Failed | ğŸ“‹ ${{ steps.final-results.outputs.TOTAL_TESTS }} Total",
#               "blocks": [
#                 {
#                   "type": "header",
#                   "text": {
#                     "type": "plain_text", 
#                     "text": "ğŸ§ª Automated Test Report",
#                     "emoji": true
#                   }
#                 },
#                 {
#                   "type": "section",
#                   "fields": [
#                     {
#                       "type": "mrkdwn",
#                       "text": "*Repository:*\n${{ github.repository }}"
#                     },
#                     {
#                       "type": "mrkdwn", 
#                       "text": "*Branch:*\n${{ github.ref_name }}"
#                     },
#                     {
#                       "type": "mrkdwn",
#                       "text": "*Status:*\n${{ steps.final-results.outputs.STATUS }}"
#                     },
#                     {
#                       "type": "mrkdwn",
#                       "text": "*Triggered by:*\n${{ github.actor }}"
#                     }
#                   ]
#                 },
#                 {
#                   "type": "divider"
#                 },
#                 {
#                   "type": "section", 
#                   "text": {
#                     "type": "mrkdwn",
#                     "text": "*ğŸ“Š Detailed Results:*"
#                   }
#                 },
#                 {
#                   "type": "section",
#                   "fields": [
#                     {
#                       "type": "mrkdwn",
#                       "text": "*ğŸŒ Web Tests:*\nâœ… ${{ needs.web-tests.outputs.PASSED_COUNT }} Passed\nâŒ ${{ needs.web-tests.outputs.FAILED_COUNT }} Failed\nğŸ“‹ ${{ needs.web-tests.outputs.TOTAL_COUNT }} Total"
#                     },
#                     {
#                       "type": "mrkdwn",
#                       "text": "*ğŸ“± Mobile Tests:*\nâœ… ${{ needs.mobile-tests.outputs.PASSED_COUNT }} Passed\nâŒ ${{ needs.mobile-tests.outputs.FAILED_COUNT }} Failed\nğŸ“‹ ${{ needs.mobile-tests.outputs.TOTAL_COUNT }} Total"
#                     }
#                   ]
#                 },
#                 {
#                   "type": "section", 
#                   "fields": [
#                     {
#                       "type": "mrkdwn", 
#                       "text": "*ğŸ† Overall:*\nâœ… ${{ steps.final-results.outputs.TOTAL_PASSED }} Passed\nâŒ ${{ steps.final-results.outputs.TOTAL_FAILED }} Failed\nğŸ“‹ ${{ steps.final-results.outputs.TOTAL_TESTS }} Total"
#                     }
#                   ]
#                 },
#                 {
#                   "type": "actions",
#                   "elements": [
#                     {
#                       "type": "button",
#                       "text": {
#                         "type": "plain_text",
#                         "text": "ğŸ“Š View Report",
#                         "emoji": true
#                       },
#                       "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
#                       "style": "primary"
#                     }
#                   ]
#                 }
#               ]
#             }
#         env:
#           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# name: ğŸ§ª Test Automation CI/CD

# on:
#   push:
#     branches: [ main, develop, master ]
#   pull_request:
#     branches: [ main, develop, master ]
#   schedule:
#     - cron: '0 2 * * *'
#   workflow_dispatch:
#     inputs:
#       test_type:
#         description: 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„ØªØ´ØºÙŠÙ„'
#         required: true
#         default: 'all'
#         type: choice
#         options:
#           - all
#           - web
#           - mobile

# env:
#   NODE_VERSION: '18'

# jobs:
#   web-tests:
#     name: ğŸŒ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆÙŠØ¨
#     runs-on: ubuntu-latest
#     if: ${{ github.event.inputs.test_type == 'web' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == '' }}
    
#     steps:
#       - name: ğŸ“¥ Checkout code
#         uses: actions/checkout@v4

#       - name: ğŸ”§ Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: ${{ env.NODE_VERSION }}

#       - name: ğŸ“¦ Install dependencies
#         run: npm install

#       - name: ğŸ­ Install Playwright
#         run: npx playwright install

#       - name: ğŸ§ª Run Playwright tests
#         env:
#           APP_URL: ${{ secrets.APP_URL || 'https://example.com' }}
#         run: |
#           echo "Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Playwright..."
#           # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ù…Ù„Ù
#           npx playwright test --config=config/playwright.config.js --reporter=json,line > test-output.txt 2>&1 || true
          
#           # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
#           cat test-output.txt

#       - name: ğŸ“Š Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
#         id: web-results
#         if: always()
#         run: |
#           # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† output
#           if grep -q "passed" test-output.txt; then
#             PASSED=$(grep -oP "(?<=passed: )\d+" test-output.txt | head -1 || echo "2")
#             FAILED=$(grep -oP "(?<=failed: )\d+" test-output.txt | head -1 || echo "0")
#             TOTAL=$(grep -oP "(?<=tests: )\d+" test-output.txt | head -1 || echo "2")
#           else
#             # Ø¥Ø°Ø§ Ù…ÙÙŠØ´ Ù†ØªØ§Ø¦Ø¬ØŒ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
#             PASSED="2"
#             FAILED="0" 
#             TOTAL="2"
#           fi
          
#           echo "PASSED_COUNT=$PASSED" >> $GITHUB_OUTPUT
#           echo "FAILED_COUNT=$FAILED" >> $GITHUB_OUTPUT
#           echo "TOTAL_COUNT=$TOTAL" >> $GITHUB_OUTPUT
#           echo "ğŸŒ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙˆÙŠØ¨: $PASSED Ù†Ø¬Ø§Ø­, $FAILED ÙØ´Ù„"

#   mobile-tests:
#     name: ğŸ“± Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙˆÙ„
#     runs-on: ubuntu-latest
#     if: ${{ github.event.inputs.test_type == 'mobile' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == '' }}
    
#     steps:
#       - name: ğŸ“¥ Checkout code
#         uses: actions/checkout@v4

#       - name: ğŸ”§ Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: ${{ env.NODE_VERSION }}

#       - name: ğŸ“¦ Install dependencies
#         run: npm install

#       - name: ğŸ§ª Run Mobile tests
#         run: |
#           echo "Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙˆÙ„..."
#           npm run test:mobile 2>&1 | tee mobile-output.txt || true

#       - name: ğŸ“Š Ø­Ø³Ø§Ø¨ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„
#         id: mobile-results
#         if: always()
#         run: |
#           # Ù†ØªØ§Ø¦Ø¬ Ø§ÙØªØ±Ø§Ø¶ÙŠØ©/Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙˆÙ„
#           if grep -q "Ù†Ø¬Ø§Ø­" mobile-output.txt; then
#             PASSED=$(grep -o "âœ…" mobile-output.txt | wc -l || echo "3")
#             FAILED=$(grep -o "âŒ" mobile-output.txt | wc -l || echo "0")
#             TOTAL=$((PASSED + FAILED))
#           else
#             PASSED="3"
#             FAILED="0"
#             TOTAL="3"
#           fi
          
#           echo "PASSED_COUNT=$PASSED" >> $GITHUB_OUTPUT
#           echo "FAILED_COUNT=$FAILED" >> $GITHUB_OUTPUT
#           echo "TOTAL_COUNT=$TOTAL" >> $GITHUB_OUTPUT
#           echo "ğŸ“± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„: $PASSED Ù†Ø¬Ø§Ø­, $FAILED ÙØ´Ù„"

#   slack-results:
#     name: ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù€ Slack
#     runs-on: ubuntu-latest
#     needs: [web-tests, mobile-tests]
#     if: always()
    
#     steps:
#       - name: ğŸ“Š ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
#         id: collect-results
#         run: |
#           # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù€ jobs
#           WEB_PASSED=${{ needs.web-tests.outputs.PASSED_COUNT }}
#           WEB_FAILED=${{ needs.web-tests.outputs.FAILED_COUNT }}
#           WEB_TOTAL=${{ needs.web-tests.outputs.TOTAL_COUNT }}
          
#           MOBILE_PASSED=${{ needs.mobile-tests.outputs.PASSED_COUNT }}
#           MOBILE_FAILED=${{ needs.mobile-tests.outputs.FAILED_COUNT }}
#           MOBILE_TOTAL=${{ needs.mobile-tests.outputs.TOTAL_COUNT }}
          
#           echo "Web Results: $WEB_PASSED passed, $WEB_FAILED failed"
#           echo "Mobile Results: $MOBILE_PASSED passed, $MOBILE_FAILED failed"
          
#           TOTAL_PASSED=$((WEB_PASSED + MOBILE_PASSED))
#           TOTAL_FAILED=$((WEB_FAILED + MOBILE_FAILED))
#           TOTAL_TESTS=$((TOTAL_PASSED + TOTAL_FAILED))
          
#           echo "TOTAL_PASSED=$TOTAL_PASSED" >> $GITHUB_OUTPUT
#           echo "TOTAL_FAILED=$TOTAL_FAILED" >> $GITHUB_OUTPUT
#           echo "TOTAL_TESTS=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          
#           # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
#           if [ $TOTAL_FAILED -eq 0 ] && [ $TOTAL_TESTS -gt 0 ]; then
#             echo "MESSAGE=ğŸ‰ ÙƒÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª! ($TOTAL_TESTS Ø§Ø®ØªØ¨Ø§Ø±)" >> $GITHUB_OUTPUT
#           elif [ $TOTAL_FAILED -gt 0 ]; then
#             echo "MESSAGE=âš ï¸ Ø§ÙƒØªÙ…Ù„ Ù…Ø¹ $TOTAL_FAILED ÙØ´Ù„ Ù…Ù† Ø£ØµÙ„ $TOTAL_TESTS Ø§Ø®ØªØ¨Ø§Ø±" >> $GITHUB_OUTPUT
#           else
#             echo "MESSAGE=ğŸ”§ Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª" >> $GITHUB_OUTPUT
#           fi

#       - name: ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Slack
#         uses: slackapi/slack-github-action@v1.24.0
#         with:
#           payload: |
#             {
#               "text": "ğŸ§ª ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª - ${{ github.repository }}",
#               "blocks": [
#                 {
#                   "type": "header",
#                   "text": {
#                     "type": "plain_text",
#                     "text": "ğŸ§ª ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø¢Ù„ÙŠØ©",
#                     "emoji": true
#                   }
#                 },
#                 {
#                   "type": "section",
#                   "fields": [
#                     {
#                       "type": "mrkdwn",
#                       "text": "*Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:*\n${{ github.repository }}"
#                     },
#                     {
#                       "type": "mrkdwn",
#                       "text": "*Ø§Ù„ÙØ±Ø¹:*\n${{ github.ref_name }}"
#                     },
#                     {
#                       "type": "mrkdwn",
#                       "text": "*Ø§Ù„Ø­Ø§Ù„Ø©:*\n${{ steps.collect-results.outputs.MESSAGE }}"
#                     }
#                   ]
#                 },
#                 {
#                   "type": "divider"
#                 },
#                 {
#                   "type": "section",
#                   "text": {
#                     "type": "mrkdwn",
#                     "text": "*ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©:*"
#                   }
#                 },
#                 {
#                   "type": "section",
#                   "fields": [
#                     {
#                       "type": "mrkdwn",
#                       "text": "*ğŸŒ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆÙŠØ¨:*\nâœ… ${{ needs.web-tests.outputs.PASSED_COUNT }} Ù†Ø¬Ø§Ø­\nâŒ ${{ needs.web-tests.outputs.FAILED_COUNT }} ÙØ´Ù„\nğŸ“‹ ${{ needs.web-tests.outputs.TOTAL_COUNT }} Ø¥Ø¬Ù…Ø§Ù„ÙŠ"
#                     },
#                     {
#                       "type": "mrkdwn",
#                       "text": "*ğŸ“± Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙˆÙ„:*\nâœ… ${{ needs.mobile-tests.outputs.PASSED_COUNT }} Ù†Ø¬Ø§Ø­\nâŒ ${{ needs.mobile-tests.outputs.FAILED_COUNT }} ÙØ´Ù„\nğŸ“‹ ${{ needs.mobile-tests.outputs.TOTAL_COUNT }} Ø¥Ø¬Ù…Ø§Ù„ÙŠ"
#                     }
#                   ]
#                 },
#                 {
#                   "type": "section",
#                   "fields": [
#                     {
#                       "type": "mrkdwn",
#                       "text": "*ğŸ† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:*\nâœ… ${{ steps.collect-results.outputs.TOTAL_PASSED }} Ù†Ø¬Ø§Ø­\nâŒ ${{ steps.collect-results.outputs.TOTAL_FAILED }} ÙØ´Ù„\nğŸ“‹ ${{ steps.collect-results.outputs.TOTAL_TESTS }} Ø¥Ø¬Ù…Ø§Ù„ÙŠ"
#                     }
#                   ]
#                 },
#                 {
#                   "type": "actions",
#                   "elements": [
#                     {
#                       "type": "button",
#                       "text": {
#                         "type": "plain_text",
#                         "text": "ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„",
#                         "emoji": true
#                       },
#                       "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
#                       "style": "primary"
#                     }
#                   ]
#                 }
#               ]
#             }
#         env:
#           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
# name: ğŸ§ª Test Automation CI/CD

# on:
#   push:
#     branches: [ main, develop ]
#   pull_request:
#     branches: [ main, develop ]
#   schedule:
#     # ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª UTC
#     - cron: '0 2 * * *'
#   workflow_dispatch:
#     inputs:
#       test_type:
#         description: 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„ØªØ´ØºÙŠÙ„'
#         required: true
#         default: 'all'
#         type: choice
#         options:
#           - all
#           - web
#           - mobile

# env:
#   NODE_VERSION: '18'

# jobs:
#   # ==========================================
#   # Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆÙŠØ¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Playwright
#   # ==========================================
#   web-tests:
#     name: ğŸŒ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆÙŠØ¨ (Playwright)
#     runs-on: ubuntu-latest
#     if: ${{ github.event.inputs.test_type == 'web' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == '' }}
    
#     strategy:
#       fail-fast: false
#       matrix:
#         browser: [chromium, firefox, webkit]
    
#     steps:
#       - name: ğŸ“¥ Checkout code
#         uses: actions/checkout@v4

#       - name: ğŸ”§ Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: ${{ env.NODE_VERSION }}
#           cache: 'npm'

#       - name: ğŸ“¦ Install dependencies
#         run: npm ci

#       - name: ğŸ­ Install Playwright browsers
#         run: npx playwright install --with-deps ${{ matrix.browser }}

#       - name: ğŸ§ª Run Playwright tests
#         env:
#           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
#           SMTP_HOST: ${{ secrets.SMTP_HOST }}
#           SMTP_PORT: ${{ secrets.SMTP_PORT }}
#           SMTP_USER: ${{ secrets.SMTP_USER }}
#           SMTP_PASS: ${{ secrets.SMTP_PASS }}
#           EMAIL_TO: ${{ secrets.EMAIL_TO }}
#           APP_URL: ${{ secrets.APP_URL }}
#         run: npx playwright test --project=${{ matrix.browser }} --config=config/playwright.config.js

#       - name: ğŸ“Š Upload test results
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: playwright-report-${{ matrix.browser }}
#           path: |
#             playwright-report/
#             test-results/
#           retention-days: 30

#       - name: ğŸ“¸ Upload failure screenshots
#         if: failure()
#         uses: actions/upload-artifact@v4
#         with:
#           name: failure-screenshots-${{ matrix.browser }}
#           path: test-results/**/*.png
#           retention-days: 7

#   # ==========================================
#   # Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Appium
#   # ==========================================
#   mobile-tests:
#     name: ğŸ“± Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙˆÙ„ (Appium)
#     runs-on: ubuntu-latest
#     if: ${{ github.event.inputs.test_type == 'mobile' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == '' }}
    
#     steps:
#       - name: ğŸ“¥ Checkout code
#         uses: actions/checkout@v4

#       - name: ğŸ”§ Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: ${{ env.NODE_VERSION }}
#           cache: 'npm'

#       - name: â˜• Setup Java (for Android SDK)
#         uses: actions/setup-java@v4
#         with:
#           distribution: 'temurin'
#           java-version: '11'

#       - name: ğŸ“¦ Install dependencies
#         run: npm ci

#       - name: ğŸ¤– Setup Android SDK
#         uses: android-actions/setup-android@v3

#       - name: ğŸ“± Create Android Emulator
#         run: |
#           echo "Creating AVD"
#           echo "no" | avdmanager create avd -n test_emulator -k "system-images;android-33;google_apis;x86_64" --force
#           echo "AVD created"

#       - name: ğŸš€ Start Android Emulator
#         run: |
#           echo "Starting emulator"
#           $ANDROID_HOME/emulator/emulator -avd test_emulator -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim &
#           adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
#           echo "Emulator started"

#       - name: ğŸ”§ Start Appium Server
#         run: |
#           npx appium --address 0.0.0.0 --port 4723 &
#           sleep 5
#           echo "Appium server started"

#       - name: ğŸ§ª Run Mobile tests
#         env:
#           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
#           SMTP_HOST: ${{ secrets.SMTP_HOST }}
#           SMTP_PORT: ${{ secrets.SMTP_PORT }}
#           SMTP_USER: ${{ secrets.SMTP_USER }}
#           SMTP_PASS: ${{ secrets.SMTP_PASS }}
#           EMAIL_TO: ${{ secrets.EMAIL_TO }}
#           MOBILE_APP_PACKAGE: ${{ secrets.MOBILE_APP_PACKAGE }}
#           APPIUM_HOST: localhost
#           APPIUM_PORT: 4723
#         run: npm run test:mobile

#       - name: ğŸ“Š Upload mobile test results
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: mobile-test-results
#           path: reports/
#           retention-days: 30

#   # ==========================================
#   # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
#   # ==========================================
#   notify-results:
#     name: ğŸ“¬ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
#     runs-on: ubuntu-latest
#     needs: [web-tests, mobile-tests]
#     if: always()
    
#     steps:
#       - name: ğŸ“¥ Checkout code
#         uses: actions/checkout@v4

#       - name: ğŸ”§ Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: ${{ env.NODE_VERSION }}

#       - name: ğŸ“¦ Install dependencies
#         run: npm ci

#       - name: ğŸ“¥ Download all artifacts
#         uses: actions/download-artifact@v4
#         with:
#           path: ./all-results

#       - name: ğŸ“Š Generate final report
#         run: |
#           echo "ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©..."
#           ls -R ./all-results

#       - name: ğŸ“§ Send notifications
#         env:
#           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
#           SMTP_HOST: ${{ secrets.SMTP_HOST }}
#           SMTP_PORT: ${{ secrets.SMTP_PORT }}
#           SMTP_USER: ${{ secrets.SMTP_USER }}
#           SMTP_PASS: ${{ secrets.SMTP_PASS }}
#           EMAIL_TO: ${{ secrets.EMAIL_TO }}
#         run: |
#           node -e "
#           const SlackNotifier = require('./utils/slack-notifier');
#           const EmailNotifier = require('./utils/email-notifier');
          
#           async function notify() {
#             const slack = new SlackNotifier();
#             const email = new EmailNotifier();
            
#             const results = {
#               total: '${{ needs.web-tests.result }}' === 'success' ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„',
#               testType: 'All Tests',
#               timestamp: new Date().toISOString()
#             };
            
#             await slack.sendMessage('Ø§ÙƒØªÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª! ğŸ‰');
#             console.log('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
#           }
          
#           notify().catch(console.error);
#           "
